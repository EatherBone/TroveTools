document.addEventListener("DOMContentLoaded", () => {
  const toolCards = document.querySelectorAll(".tool-card");
  const modalContainer = document.getElementById("toolModal");
  const modalBody = document.getElementById("modalBody");
  const modalCloseBtn = document.getElementById("modalCloseBtn");
  const toolPanelsContainer = document.getElementById("tool-panels");

  function initializeScripts(targetId, container) {
    if (targetId === 'roiCalc') initializeRoiCalculator(container);
    else if (targetId === 'depthsSoulCalc') initializeDepthsSoulsCalculator(container);
    else if (targetId === 'venturineCalc') initializeVenturineCalculator(container);
    else if (targetId === 'trunkDropCalc') initializeTrunkDropCalculator(container);
    else if (targetId === 'gem-augment-calculator') initializeGemAugmentCalculator(container);
    else if (targetId === 'dragonCalc') initializeDragonCoinCalculator(container);
    else if (targetId === 'depthsCalc') initializeDepthsCoreCalculator(container);
    else if (targetId === 'cubitCalc') initializeCubitCalculator(container);
    else if (targetId === 'pr') initializePowerRankCalculator(container);
    else if (targetId === 'challengeSpinner') initializeSpinner(container);
  }

  toolCards.forEach(card => {
    card.addEventListener("click", () => {
      const targetId = card.dataset.target;
      const toolPanel = toolPanelsContainer.querySelector(`#${targetId}`);
      if (toolPanel) {
        modalBody.innerHTML = '';
        const clonedPanel = toolPanel.cloneNode(true);
        modalBody.appendChild(clonedPanel);
        modalContainer.classList.add("active");
        document.body.style.overflow = 'hidden';
        initializeScripts(targetId, modalBody);
      }
    });
  });

  const closeModal = () => {
    modalContainer.classList.remove("active");
    document.body.style.overflow = '';
  };

  modalCloseBtn.addEventListener("click", closeModal);
  modalContainer.addEventListener("click", (e) => { if (e.target === modalContainer) closeModal(); });
  document.addEventListener("keydown", (e) => { if (e.key === "Escape" && modalContainer.classList.contains("active")) closeModal(); });
});